<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>LiveKit Web Publisher Â· iOS Safari</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="ä½¿ç”¨æ‰‹æ©Ÿç›¸æ©Ÿå’Œéº¥å…‹é¢¨é€²è¡Œ WebRTC ç›´æ’­ä¸²æµ" />
  <meta name="theme-color" content="#2d7cf0" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="LiveKitç›´æ’­" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/static/manifest.json" />
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMzIiIGZpbGw9IiMyZDdjZjAiLz4KPHBhdGggZD0iTTQ4IDY0djY0aDMyVjk2aDMydjMyaDMyVjY0SDQ4WiIgZmlsbD0id2hpdGUiLz4KPGNpcmNsZSBjeD0iMTI4IiBjeT0iODAiIHI9IjgiIGZpbGw9IiNlMjNlNTciLz4KPC9zdmc+" />
  <style>
    :root {
      --primary-color: #2d7cf0;
      --secondary-color: #223055;
      --danger-color: #e23e57;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --bg-primary: #0b1020;
      --bg-secondary: #121a32;
      --bg-card: #1e2a4a;
      --text-primary: #e9eef9;
      --text-secondary: #9fb3d1;
      --text-muted: #7487a8;
      --border-radius: 16px;
      --touch-target-size: 48px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system,BlinkMacSystemFont,Helvetica,Arial,"Segoe UI",sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    .wrap {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
      min-height: 100vh;
    }

    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--bg-card);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
    }

    label {
      display: block;
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    input {
      width: 100%;
      padding: 14px 16px;
      border-radius: 12px;
      border: 2px solid var(--bg-card);
      background: #0e1530;
      color: var(--text-primary);
      font-size: 16px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      -webkit-appearance: none;
      appearance: none;
    }

    input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(45, 124, 240, 0.1);
    }

    input::placeholder {
      color: var(--text-muted);
    }

    .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media(min-width: 720px) {
      .row {
        grid-template-columns: 1.2fr 1fr;
      }
    }

    button {
      cursor: pointer;
      border: 0;
      padding: 16px 20px;
      border-radius: 12px;
      background: var(--primary-color);
      color: white;
      font-weight: 600;
      font-size: 16px;
      min-height: var(--touch-target-size);
      min-width: var(--touch-target-size);
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      -webkit-appearance: none;
      appearance: none;
    }

    button:active {
      transform: scale(0.98);
    }

    button.secondary {
      background: var(--secondary-color);
    }

    button.danger {
      background: var(--danger-color);
    }

    button.success {
      background: var(--success-color);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btns {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 16px;
    }

    .btns button {
      flex: 1;
      min-width: 120px;
    }

    @media(max-width: 480px) {
      .btns {
        flex-direction: column;
      }
      
      .btns button {
        width: 100%;
      }
    }

    .hint {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    video {
      width: 100%;
      max-height: 70vh;
      background: #000;
      border-radius: var(--border-radius);
      border: 1px solid var(--bg-card);
      object-fit: cover;
    }

    .video-container {
      position: relative;
      overflow: hidden;
      border-radius: var(--border-radius);
    }

    .video-fullscreen-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      color: white;
      padding: 8px;
      border-radius: 8px;
      font-size: 18px;
      min-height: 40px;
      min-width: 40px;
      cursor: pointer;
      z-index: 10;
    }

    .badge {
      display: inline-block;
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 999px;
      background: #1c2848;
      color: #9cc2ff;
      font-weight: 500;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 500;
    }

    .status-badge.connected {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success-color);
    }

    .status-badge.connecting {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning-color);
    }

    .status-badge.disconnected {
      background: rgba(226, 62, 87, 0.2);
      color: var(--danger-color);
    }

    .network-quality {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }

    .network-bars {
      display: flex;
      gap: 2px;
      align-items: flex-end;
    }

    .network-bar {
      width: 3px;
      background: currentColor;
      border-radius: 1px;
      transition: opacity 0.3s ease;
    }

    .network-bar:nth-child(1) { height: 4px; }
    .network-bar:nth-child(2) { height: 7px; }
    .network-bar:nth-child(3) { height: 10px; }
    .network-bar:nth-child(4) { height: 13px; }

    .network-quality.excellent { color: var(--success-color); }
    .network-quality.good { color: #10b981; }
    .network-quality.poor { color: var(--warning-color); }
    .network-quality.bad { color: var(--danger-color); }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }

    .mono {
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* è§¸æ§å„ªåŒ– */
    @media (hover: none) and (pointer: coarse) {
      button {
        padding: 18px 24px;
      }
      
      input {
        padding: 16px 18px;
      }
      
      .card {
        padding: 24px;
      }
    }

    /* æ©«å‘æ¨¡å¼å„ªåŒ– */
    @media (orientation: landscape) and (max-height: 500px) {
      .wrap {
        padding: 12px;
      }
      
      .card {
        padding: 16px;
      }
      
      video {
        max-height: 50vh;
      }
    }
  </style>
  <!-- LiveKit JSï¼ˆES Module ç‰ˆï¼‰ -->
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“¹ LiveKit æ‰‹æ©Ÿç›´æ’­ä¸²æµ</h1>
    <p class="hint">ä½¿ç”¨ <span class="badge">WebRTC</span> å°‡æ‰‹æ©Ÿç›¸æ©Ÿ/éº¥å…‹é¢¨æ¨é€åˆ° LiveKit æˆ¿é–“ã€‚<span class="badge">PWA</span> æ”¯æ´ï¼Œå¯å®‰è£åˆ°æ¡Œé¢ä½¿ç”¨ã€‚</p>

    <div class="card" style="margin-top:14px">
      <div class="row">
        <div>
          <label>æˆ¿é–“åç¨±</label>
          <input id="roomName" value="Drone-RTC-01" placeholder="è¼¸å…¥æˆ¿é–“åç¨±" />
        </div>
        <div>
          <label>èº«ä»½åç¨±ï¼ˆé¸å¡«ï¼‰</label>
          <input id="identity" placeholder="ç•™ç©ºå°‡è‡ªå‹•ç”¢ç”Ÿ" />
        </div>
      </div>
      <div class="hint" style="margin-top: 8px;">
        ğŸ“± <strong>è‡ªå‹•æ¨¡å¼ï¼š</strong>å°‡è‡ªå‹•å¾ä¼ºæœå™¨ç²å–é€£ç·šæ†‘è­‰ï¼Œç„¡éœ€æ‰‹å‹•è¨­å®š Token
      </div>
      
      <!-- é€²éšè¨­å®šï¼ˆå¯æ‘ºç–Šï¼‰ -->
      <details style="margin-top: 12px;">
        <summary style="cursor: pointer; color: var(--text-secondary);">ğŸ”§ é€²éšè¨­å®š</summary>
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--bg-card);">
          <div class="row">
            <div>
              <label>LiveKit ä¼ºæœå™¨ç¶²å€ï¼ˆæ‰‹å‹•æ¨¡å¼ï¼‰</label>
              <input id="serverUrl" placeholder="ç•™ç©ºä½¿ç”¨è‡ªå‹•æ¨¡å¼" />
            </div>
            <div>
              <label>Access Tokenï¼ˆæ‰‹å‹•æ¨¡å¼ï¼‰</label>
              <input id="token" placeholder="ç•™ç©ºä½¿ç”¨è‡ªå‹•æ¨¡å¼" />
            </div>
          </div>
        </div>
      </details>
      
      <div class="btns">
        <button id="btnJoin">é€£ç·šä¸¦æ¨æµ</button>
        <button id="btnLeave" class="danger" disabled>é›¢ç·š</button>
        <button id="btnFlip" class="secondary" disabled>åˆ‡æ›å‰/å¾Œé¡é ­</button>
        <button id="btnMuteAudio" class="secondary" disabled>éœéŸ³</button>
        <button id="btnMuteVideo" class="secondary" disabled>é—œé–‰å½±åƒ</button>
      </div>
      <div id="status" class="status-badge disconnected" style="margin-top:16px">
        <div class="status-indicator"></div>
        <span id="statusText">å°šæœªé€£ç·š</span>
      </div>
      <div id="networkQuality" class="hint" style="margin-top:8px; display:none">
        <span id="networkQualityText">ç¶²è·¯å“è³ªæª¢æ¸¬ä¸­...</span>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <label>æœ¬åœ°é è¦½ï¼ˆåƒ…ä½œç‚ºç¢ºèªï¼›å¯¦éš›è§€çœ¾æœƒåœ¨è¨‚é–±ç«¯è§€çœ‹ï¼‰</label>
      <div class="video-container">
        <video id="preview" playsinline autoplay muted></video>
        <button id="fullscreenBtn" class="video-fullscreen-btn" title="å…¨è¢å¹•é è¦½">â›¶</button>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="grid-3">
        <div>
          <label>è§£æåº¦</label>
          <input id="res" value="1280x720" />
        </div>
        <div>
          <label>FPS</label>
          <input id="fps" value="30" />
        </div>
        <div>
          <label>GOPï¼ˆç§’ï¼Œéµå½±æ ¼é–“éš”ï¼‰</label>
          <input id="gop" value="2" />
        </div>
      </div>
      <p class="hint">æç¤ºï¼šiOS éœ€ä½¿ç”¨è€…æ‰‹å‹¢å•Ÿå‹•ï¼›æœ¬é é¢é€éã€Œé€£ç·šä¸¦æ¨æµã€æŒ‰éˆ•å–å¾—ç›¸æ©Ÿ/éº¥å…‹é¢¨æ¬Šé™ã€‚å»ºè­°åœ¨ä½å…‰ç’°å¢ƒé™ä½ FPS/è§£æåº¦ã€‚</p>
    </div>
  </div>

<script type="module">
  // å°å…¥ LiveKit ç›¸é—œåŠŸèƒ½
  import { 
    Room, 
    RoomEvent, 
    Track,
    TrackPublication,
    setLogLevel, 
    LogLevel,
    LocalAudioTrack,
    LocalVideoTrack
  } from 'https://cdn.jsdelivr.net/npm/livekit-client@2/dist/livekit-client.esm.mjs';

  // ä¸»è¦é‚è¼¯
  const $ = (id)=>document.getElementById(id);
  const status = (text, type = 'disconnected') => {
    const statusEl = $('status');
    const statusTextEl = $('statusText');
    statusEl.className = `status-badge ${type}`;
    statusTextEl.textContent = text;
  };

  let room = null;
  let facing = 'environment';
  let joined = false;
  let wakeLock = null;

  // Screen Wake Lock åŠŸèƒ½
  async function requestWakeLock() {
    try {
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
        console.log('Screen Wake Lock å·²å•Ÿå‹•');
        
        wakeLock.addEventListener('release', () => {
          console.log('Screen Wake Lock å·²é‡‹æ”¾');
        });
        
        return true;
      }
    } catch (err) {
      console.warn('ç„¡æ³•å•Ÿå‹• Screen Wake Lock:', err);
    }
    return false;
  }

  function releaseWakeLock() {
    if (wakeLock) {
      wakeLock.release();
      wakeLock = null;
      console.log('æ‰‹å‹•é‡‹æ”¾ Screen Wake Lock');
    }
  }

  // è™•ç†é é¢å¯è¦‹æ€§è®ŠåŒ–ï¼ˆç•¶ç”¨æˆ¶åˆ‡æ›åˆ°å…¶ä»– app æ™‚é‡æ–°è«‹æ±‚ wake lockï¼‰
  document.addEventListener('visibilitychange', async () => {
    if (joined && wakeLock !== null && document.visibilityState === 'visible') {
      await requestWakeLock();
    }
  });

  // è£ç½®æ–¹å‘è™•ç†
  let currentOrientation = screen.orientation?.angle || 0;

  function handleOrientationChange() {
    const newOrientation = screen.orientation?.angle || 0;
    const orientationChanged = Math.abs(newOrientation - currentOrientation) === 90 || 
                              Math.abs(newOrientation - currentOrientation) === 270;
    
    if (orientationChanged && camTrack) {
      console.log('è£ç½®æ–¹å‘æ”¹è®Šï¼Œæ–¹å‘è§’åº¦:', newOrientation);
      currentOrientation = newOrientation;
      
      // å»¶é²ä¸€é»æ™‚é–“è®“ CSS åª’é«”æŸ¥è©¢ç”Ÿæ•ˆ
      setTimeout(() => {
        // é€šçŸ¥ä½¿ç”¨è€…æ–¹å‘å·²æ”¹è®Šï¼Œå¯èƒ½éœ€è¦èª¿æ•´è¨­å®š
        if (joined) {
          status('è£ç½®æ–¹å‘å·²æ”¹è®Šï¼ˆé¡é ­ï¼š' + (facing==='environment'?'å¾Œç½®':'å‰ç½®') + 'ï¼‰', 'connected');
        }
      }, 100);
    }
  }

  // ç›£è½è¢å¹•æ–¹å‘è®ŠåŒ–
  if (screen.orientation) {
    screen.orientation.addEventListener('change', handleOrientationChange);
  } else {
    // èˆŠç‰ˆç€è¦½å™¨æ”¯æ´
    window.addEventListener('orientationchange', handleOrientationChange);
  }

  // ç›¸æ©Ÿèˆ‡éŸ³è¨Šå„ªåŒ–ï¼ˆLiveKit Room API å…§å»ºè™•ç†ï¼‰

  // ç›¸æ©Ÿæ¬Šé™æª¢æŸ¥èˆ‡éŒ¯èª¤æ¢å¾©
  async function checkCameraPermissions() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      stream.getTracks().forEach(track => track.stop());
      return true;
    } catch (error) {
      console.warn('ç›¸æ©Ÿæ¬Šé™æª¢æŸ¥å¤±æ•—:', error);
      return false;
    }
  }

  // æ›´å¥½çš„éŒ¯èª¤è™•ç†
  function handleMediaError(error, type) {
    let userMessage = '';
    
    switch (error.name) {
      case 'NotAllowedError':
        userMessage = `è«‹å…è¨±å­˜å–${type}æ¬Šé™ï¼Œç„¶å¾Œé‡æ–°å˜—è©¦é€£ç·šã€‚`;
        break;
      case 'NotFoundError':
        userMessage = `æ‰¾ä¸åˆ°å¯ç”¨çš„${type}è£ç½®ã€‚`;
        break;
      case 'NotReadableError':
        userMessage = `${type}è£ç½®è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½”ç”¨ã€‚`;
        break;
      case 'OverconstrainedError':
        userMessage = `${type}è¨­å®šä¸è¢«æ”¯æ´ï¼Œå°‡ä½¿ç”¨é è¨­è¨­å®šé‡è©¦ã€‚`;
        break;
      case 'SecurityError':
        userMessage = `${type}å­˜å–è¢«é˜»æ­¢ï¼ˆå®‰å…¨æ€§é™åˆ¶ï¼‰ã€‚`;
        break;
      default:
        userMessage = `${type}å­˜å–å¤±æ•—: ${error.message}`;
    }
    
    return userMessage;
  }

  // ç¶²è·¯å“è³ªç›£æ§
  let networkQualityTimer = null;

  function updateNetworkQuality(quality) {
    const networkEl = $('networkQuality');
    const networkTextEl = $('networkQualityText');
    
    if (!quality) {
      networkEl.style.display = 'none';
      return;
    }

    networkEl.style.display = 'block';
    
    const qualityMap = {
      0: { text: 'ç¶²è·¯å“è³ªï¼šæœªçŸ¥', class: 'poor', bars: 0 },
      1: { text: 'ç¶²è·¯å“è³ªï¼šå·®', class: 'bad', bars: 1 },
      2: { text: 'ç¶²è·¯å“è³ªï¼šæ™®é€š', class: 'poor', bars: 2 },
      3: { text: 'ç¶²è·¯å“è³ªï¼šè‰¯å¥½', class: 'good', bars: 3 },
      4: { text: 'ç¶²è·¯å“è³ªï¼šå„ªç§€', class: 'excellent', bars: 4 },
      5: { text: 'ç¶²è·¯å“è³ªï¼šå„ªç§€', class: 'excellent', bars: 4 }
    };

    const qualityInfo = qualityMap[quality] || qualityMap[0];
    
    // æ›´æ–°ç¶²è·¯å“è³ªé¡¯ç¤º
    const barsHtml = Array.from({ length: 4 }, (_, i) => 
      `<div class="network-bar" style="opacity: ${i < qualityInfo.bars ? 1 : 0.3}"></div>`
    ).join('');
    
    networkTextEl.innerHTML = `
      <div class="network-quality ${qualityInfo.class}">
        <div class="network-bars">${barsHtml}</div>
        ${qualityInfo.text}
      </div>
    `;
  }

  async function monitorConnectionQuality() {
    if (!room || !joined) return;

    try {
      // ä½¿ç”¨ LiveKit çš„é€£ç·šçµ±è¨ˆ
      const stats = await room.engine.getConnectedServerAddress();
      
      // ç°¡å–®çš„ RTT æ¸¬è©¦ä¾†è©•ä¼°ç¶²è·¯å“è³ª
      const startTime = Date.now();
      await fetch(window.location.origin + '/api/token?room=ping-test')
        .catch(() => {}); // å¿½ç•¥éŒ¯èª¤ï¼Œåªæ¸¬è©¦å»¶é²
      const rtt = Date.now() - startTime;

      let quality = 0;
      if (rtt < 50) quality = 5;       // å„ªç§€
      else if (rtt < 100) quality = 4; // è‰¯å¥½  
      else if (rtt < 200) quality = 3; // æ™®é€š
      else if (rtt < 500) quality = 2; // å·®
      else quality = 1;                // å¾ˆå·®

      updateNetworkQuality(quality);
      
      // æ ¹æ“šç¶²è·¯å“è³ªå‹•æ…‹èª¿æ•´è¨­å®š
      if (quality <= 2 && camTrack) {
        // ç¶²è·¯å“è³ªå·®æ™‚é™ä½å“è³ª
        console.log('ç¶²è·¯å“è³ªå·®ï¼Œå»ºè­°é™ä½è§£æåº¦æˆ–FPS');
      }

    } catch (error) {
      console.warn('ç¶²è·¯å“è³ªç›£æ§å¤±æ•—:', error);
      updateNetworkQuality(0);
    }
  }

  // ç¶²è·¯é€£ç·šè®ŠåŒ–ç›£è½
  function setupNetworkMonitoring() {
    if ('connection' in navigator) {
      navigator.connection.addEventListener('change', () => {
        const connection = navigator.connection;
        console.log('ç¶²è·¯é€£ç·šè®ŠåŒ–:', {
          effectiveType: connection.effectiveType,
          downlink: connection.downlink,
          rtt: connection.rtt
        });
        
        // ç«‹å³æª¢æŸ¥ç¶²è·¯å“è³ª
        if (joined) {
          setTimeout(monitorConnectionQuality, 100);
        }
      });
    }

    // å®šæœŸç›£æ§ç¶²è·¯å“è³ª
    networkQualityTimer = setInterval(() => {
      if (joined) {
        monitorConnectionQuality();
      }
    }, 5000); // æ¯5ç§’æª¢æŸ¥ä¸€æ¬¡
  }

  // PWA åŠŸèƒ½
  let deferredPrompt;
  let pwaInstalled = false;

  // è¨»å†Š Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const registration = await navigator.serviceWorker.register('/static/sw.js');
        console.log('Service Worker è¨»å†ŠæˆåŠŸ:', registration);
        
        registration.addEventListener('updatefound', () => {
          console.log('ç™¼ç¾ Service Worker æ›´æ–°');
        });
      } catch (error) {
        console.warn('Service Worker è¨»å†Šå¤±æ•—:', error);
      }
    });
  }

  // PWA å®‰è£æç¤º
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // é¡¯ç¤ºå®‰è£æç¤ºï¼ˆå¯ä»¥æ·»åŠ è‡ªå®šç¾© UIï¼‰
    console.log('PWA å¯ä»¥å®‰è£');
    
    // å¦‚æœç”¨æˆ¶å°šæœªå®‰è£ï¼Œå¯ä»¥åœ¨é©ç•¶æ™‚æ©Ÿé¡¯ç¤ºå®‰è£æŒ‰éˆ•
    if (!pwaInstalled) {
      showInstallBanner();
    }
  });

  // æª¢æ¸¬ PWA å®‰è£ç‹€æ…‹
  window.addEventListener('appinstalled', (evt) => {
    console.log('PWA å·²å®‰è£');
    pwaInstalled = true;
    hideInstallBanner();
  });

  function showInstallBanner() {
    // å¯ä»¥åœ¨é€™è£¡æ·»åŠ å®‰è£æ©«å¹…çš„ UI
    const hint = $('hint-install');
    if (hint) {
      hint.style.display = 'block';
    }
  }

  function hideInstallBanner() {
    const hint = $('hint-install');
    if (hint) {
      hint.style.display = 'none';
    }
  }

  // æ‰‹å‹•è§¸ç™¼ PWA å®‰è£
  async function installPWA() {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('PWA å®‰è£çµæœ:', outcome);
      deferredPrompt = null;
    }
  }

  // é›¢ç·šç‹€æ…‹æª¢æ¸¬
  function updateOnlineStatus() {
    const isOnline = navigator.onLine;
    const statusEl = $('status');
    
    if (!isOnline && joined) {
      status('ç¶²è·¯é€£ç·šä¸­æ–·', 'disconnected');
    } else if (isOnline && !joined) {
      status('å°šæœªé€£ç·š', 'disconnected');
    }
  }

  window.addEventListener('online', updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);

  async function joinAndPublish(){
    const manualServerUrl = $('serverUrl').value.trim();
    const manualToken = $('token').value.trim();
    const roomName = $('roomName').value.trim();
    const identity = $('identity').value.trim();
    
    if(!roomName){
      alert('è«‹å¡«å¯«æˆ¿é–“åç¨±');
      return;
    }

    let serverUrl, token;
    
    // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨æ‰‹å‹•æ¨¡å¼
    if(manualServerUrl && manualToken){
      serverUrl = manualServerUrl;
      token = manualToken;
      console.log('ä½¿ç”¨æ‰‹å‹•æ¨¡å¼é€£ç·š');
    } else {
      // è‡ªå‹•æ¨¡å¼ï¼šå¾å¾Œç«¯ API ç²å– token
      try {
        status('ç²å–é€£ç·šæ†‘è­‰ä¸­...', 'connecting');
        const apiUrl = identity 
          ? `/api/publisher-token?room=${encodeURIComponent(roomName)}&identity=${encodeURIComponent(identity)}`
          : `/api/publisher-token?room=${encodeURIComponent(roomName)}`;
          
        const response = await fetch(apiUrl);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        serverUrl = data.server_url;
        token = data.token;
        console.log('è‡ªå‹•ç²å–é€£ç·šæ†‘è­‰æˆåŠŸï¼Œæˆ¿é–“ï¼š', data.room, 'èº«ä»½ï¼š', data.identity);
      } catch (error) {
        console.error('ç²å–é€£ç·šæ†‘è­‰å¤±æ•—:', error);
        alert('ç„¡æ³•ç²å–é€£ç·šæ†‘è­‰ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨è¨­å®šæˆ–ä½¿ç”¨æ‰‹å‹•æ¨¡å¼: ' + (error?.message || error));
        status('ç²å–é€£ç·šæ†‘è­‰å¤±æ•—', 'disconnected');
        return;
      }
    }

    disableUI(true);
    try{
      setLogLevel(LogLevel.info);
      status('é€£ç·šä¸­ â€¦', 'connecting');

      // å»ºç«‹æˆ¿é–“ä¸¦è¨­å®šé¸é …
      room = new Room({
        adaptiveStream: true,
        dynacast: true,
        publishDefaults: {
          simulcast: true,
          videoEncoding: { maxBitrate: 2_000_000, maxFramerate: parseInt($('fps').value||'30',10) }
        }
      });

      bindRoomEvents(room);
      
      // é€£ç·šåˆ°æˆ¿é–“
      await room.connect(serverUrl, token);
      status('å·²é€£ç·šï¼Œæº–å‚™å•Ÿç”¨ç›¸æ©Ÿèˆ‡éº¥å…‹é¢¨â€¦', 'connecting');

      // å•Ÿç”¨ç›¸æ©Ÿå’Œéº¥å…‹é¢¨
      try {
        console.log('æ­£åœ¨å•Ÿç”¨ç›¸æ©Ÿï¼Œæ¨¡å¼:', facing);
        
        // å•Ÿç”¨ç›¸æ©Ÿ
        await room.localParticipant.setCameraEnabled(true, {
          facingMode: facing,
          resolution: { width: 1280, height: 720 },
          frameRate: 30
        });
        
        // å•Ÿç”¨éº¥å…‹é¢¨
        await room.localParticipant.setMicrophoneEnabled(true);
        
        console.log('åª’é«”è¨­å‚™å·²å•Ÿç”¨ï¼Œç­‰å¾…è»Œé“ç™¼ä½ˆäº‹ä»¶...');
        
        // é è¦½å°‡é€šéäº‹ä»¶ç›£è½å™¨è‡ªå‹•è™•ç†
        // æ·»åŠ å‚™ç”¨æª¢æŸ¥ï¼Œä»¥é˜²äº‹ä»¶æ²’æœ‰è§¸ç™¼
        setTimeout(() => {
          const videoTrack = room.localParticipant.videoTrackPublications.values().next().value?.track;
          if (videoTrack && videoTrack.track) {
            console.log('å‚™ç”¨æ–¹æ¡ˆï¼šæ‰‹å‹•é™„åŠ é è¦½');
            attachVideoPreview(videoTrack.track);
          }
        }, 1000);
        
      } catch (mediaError) {
        console.error('å•Ÿç”¨åª’é«”è¨­å‚™å¤±æ•—:', mediaError);
        const errorMsg = handleMediaError(mediaError, 'ç›¸æ©Ÿæˆ–éº¥å…‹é¢¨');
        throw new Error(errorMsg);
      }

      // è¨­å®šéµå½±æ ¼é–“éš”ï¼ˆä»¥ç§’ç‚ºå–®ä½æä¾›å»ºè­°ï¼›å¯¦éš›ç”±å¯¦ä½œæ±ºå®šï¼ŒSafari å¯èƒ½å¿½ç•¥ï¼‰
      // é€™è£¡åƒ…ä½œæ¼”ç¤ºï¼Œä¸ä¿è­‰æ‰€æœ‰ç€è¦½å™¨æœ‰æ•ˆã€‚

      status('æ¨æµä¸­ï¼ˆé¡é ­ï¼š' + (facing==='environment'?'å¾Œç½®':'å‰ç½®') + 'ï¼‰', 'connected');
      $('btnLeave').disabled = false;
      $('btnFlip').disabled = false;
      $('btnMuteAudio').disabled = false;
      $('btnMuteVideo').disabled = false;
      joined = true;
      
      // å•Ÿå‹• Screen Wake Lock é˜²æ­¢è¢å¹•ä¼‘çœ 
      await requestWakeLock();
      
      // å•Ÿå‹•ç¶²è·¯å“è³ªç›£æ§
      setupNetworkMonitoring();
      setTimeout(monitorConnectionQuality, 1000);
    } catch(e){
      console.error(e);
      alert('é€£ç·šæˆ–æ¨æµå¤±æ•—ï¼š' + (e?.message||e));
      status('éŒ¯èª¤ï¼š' + (e?.message||e), 'disconnected');
      await leave();
    } finally{
      disableUI(false);
    }
  }

  async function flipCamera(){
    if(!room || !joined) return;
    try{
      const next = (facing==='environment') ? 'user' : 'environment';
      console.log('åˆ‡æ›é¡é ­å¾', facing, 'åˆ°', next);
      
      // å…ˆé—œé–‰ç›¸æ©Ÿ
      await room.localParticipant.setCameraEnabled(false);
      
      // é‡æ–°å•Ÿç”¨ç›¸æ©Ÿï¼Œä½¿ç”¨æ–°çš„ facingMode
      await room.localParticipant.setCameraEnabled(true, {
        facingMode: next,
        resolution: { width: 1280, height: 720 },
        frameRate: 30
      });
      
      // é è¦½å°‡é€šéäº‹ä»¶ç›£è½å™¨è‡ªå‹•æ›´æ–°

      facing = next;
      status('æ¨æµä¸­ï¼ˆé¡é ­ï¼š' + (facing==='environment'?'å¾Œç½®':'å‰ç½®') + 'ï¼‰', 'connected');
    }catch(e){
      console.error('åˆ‡æ›é¡é ­å¤±æ•—:', e);
      alert('åˆ‡æ›é¡é ­å¤±æ•—ï¼š' + (e?.message||e));
    }
  }

  async function toggleAudio(){
    if(!room || !joined) return;
    try{
      const isEnabled = room.localParticipant.isMicrophoneEnabled;
      await room.localParticipant.setMicrophoneEnabled(!isEnabled);
      $('btnMuteAudio').textContent = isEnabled ? 'é–‹å•Ÿéº¥å…‹é¢¨' : 'éœéŸ³';
    }catch(e){ console.error(e); }
  }

  async function toggleVideo(){
    if(!room || !joined) return;
    try{
      const isEnabled = room.localParticipant.isCameraEnabled;
      await room.localParticipant.setCameraEnabled(!isEnabled);
      $('btnMuteVideo').textContent = isEnabled ? 'é–‹å•Ÿå½±åƒ' : 'é—œé–‰å½±åƒ';
    }catch(e){ console.error(e); }
  }

  function bindRoomEvents(r){
    r.on(RoomEvent.ConnectionStateChanged, (state)=>{
      const stateMap = {
        'connected': 'connected',
        'connecting': 'connecting',
        'disconnected': 'disconnected',
        'reconnecting': 'connecting'
      };
      status('é€£ç·šç‹€æ…‹ï¼š' + state, stateMap[state] || 'disconnected');
    });
    r.on(RoomEvent.Disconnected, async ()=>{
      status('å·²é›¢ç·š', 'disconnected');
      await leave();
    });
    r.on(RoomEvent.ParticipantConnected, (p)=>{
      console.log('è§€çœ¾åŠ å…¥ï¼š', p.identity);
    });
    r.on(RoomEvent.ParticipantDisconnected, (p)=>{
      console.log('è§€çœ¾é›¢é–‹ï¼š', p.identity);
    });
    
    // ç›£è½æœ¬åœ°è»Œé“ç™¼ä½ˆäº‹ä»¶ä»¥æ›´æ–°é è¦½
    r.on(RoomEvent.LocalTrackPublished, (publication, participant) => {
      console.log('æœ¬åœ°è»Œé“å·²ç™¼ä½ˆï¼š', publication.kind);
      if (publication.kind === Track.Kind.Video && publication.track) {
        attachVideoPreview(publication.track);
      }
    });
    
    // ç›£è½è»Œé“éœéŸ³/å–æ¶ˆéœéŸ³äº‹ä»¶
    r.on(RoomEvent.LocalTrackUnpublished, (publication, participant) => {
      console.log('æœ¬åœ°è»Œé“å·²å–æ¶ˆç™¼ä½ˆï¼š', publication.kind);
      if (publication.kind === Track.Kind.Video) {
        clearVideoPreview();
      }
    });
  }

  // é™„åŠ è¦–è¨Šè»Œé“åˆ°é è¦½å…ƒç´ 
  function attachVideoPreview(track) {
    try {
      const videoEl = $('preview');
      console.log('é™„åŠ è¦–è¨Šè»Œé“åˆ°é è¦½:', track);
      track.attach(videoEl);
    } catch (error) {
      console.warn('é™„åŠ é è¦½å¤±æ•—:', error);
    }
  }

  // æ¸…é™¤è¦–è¨Šé è¦½
  function clearVideoPreview() {
    try {
      const videoEl = $('preview');
      videoEl.srcObject = null;
      console.log('å·²æ¸…é™¤è¦–è¨Šé è¦½');
    } catch (error) {
      console.warn('æ¸…é™¤é è¦½å¤±æ•—:', error);
    }
  }

  async function leave(){
    try{
      if(room){ 
        await room.disconnect(); 
        room = null; 
      }
      
      // æ¸…ç†é è¦½
      clearVideoPreview();
      
      // é‡‹æ”¾ Screen Wake Lock
      releaseWakeLock();
      
      // åœæ­¢ç¶²è·¯å“è³ªç›£æ§
      if (networkQualityTimer) {
        clearInterval(networkQualityTimer);
        networkQualityTimer = null;
      }
      updateNetworkQuality(null);
    } catch(e){ console.warn(e); }
    $('btnLeave').disabled = true;
    $('btnFlip').disabled = true;
    $('btnMuteAudio').disabled = true;
    $('btnMuteVideo').disabled = true;
    joined = false;
  }

  function disableUI(b){
    $('btnJoin').disabled = b || joined;
    $('roomName').disabled = b || joined;
    $('identity').disabled = b || joined;
    $('serverUrl').disabled = b || joined;
    $('token').disabled = b || joined;
  }

  // å…¨è¢å¹•é è¦½åŠŸèƒ½
  function toggleFullscreen() {
    const video = $('preview');
    if (!document.fullscreenElement) {
      video.requestFullscreen().catch(console.warn);
    } else {
      document.exitFullscreen().catch(console.warn);
    }
  }

  $('btnJoin').addEventListener('click', joinAndPublish, {passive:true});
  $('btnLeave').addEventListener('click', leave, {passive:true});
  $('btnFlip').addEventListener('click', flipCamera, {passive:true});
  $('btnMuteAudio').addEventListener('click', toggleAudio, {passive:true});
  $('btnMuteVideo').addEventListener('click', toggleVideo, {passive:true});
  $('fullscreenBtn').addEventListener('click', toggleFullscreen, {passive:true});

</script>
</body>
</html>
